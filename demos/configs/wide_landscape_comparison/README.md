# Wide Loss Landscape Comparison Configs

## üéØ Goal

**See IDENTICAL landscape structure at initialization and after training** by using:
- ‚úÖ **Identical PCA directions** (saved from config 2, loaded by config 1)
- ‚úÖ **Same range_scale** (1.5)
- ‚úÖ **Same resolution** (50√ó50 grid)
- ‚úÖ **Same random seed** (42)
- ‚úÖ **Pre-normalized directions** (skip re-normalization to ensure identical usage)

## üìÅ Configuration Files

### 1. `02_trained_with_pca.yaml` - **RUN THIS FIRST** ‚≠ê

**What it does:**
- Trains fully (100 epochs)
- Computes PCA directions from training trajectory
- **Normalizes directions** based on trained model parameters
- **Saves normalized PCA directions** to `pca_directions.pt`
- Samples landscape using these directions at **trained position**

**Key:** This generates the normalized PCA directions file that config 1 will use.

### 2. `01_init_with_pca.yaml` - Initial Position with Same PCA Directions

**What it does:**
- **Loads pre-normalized PCA directions** from `pca_directions.pt` (generated by config 2)
- **Skips re-normalization** (uses directions directly)
- Samples landscape using **exact same directions** at **initial position**

**Key insight:** See the landscape in the **exact same direction** as training, but at the starting point!

### 3. `03_brief_trained_with_pca.yaml` - Brief Training Position

**What it does:**
- Trains briefly (20 epochs)
- Samples landscape using PCA directions at **brief training position**

**Key insight:** Compare with config 1 to see how landscape changes after brief training.

## üîë Key Features

### Identical PCA Directions ‚≠ê

Config 2 saves **pre-normalized** PCA directions, and Config 1 loads and uses them **without re-normalization**:
- **Config 2**: Computes PCA from 100 epochs training ‚Üí normalizes ‚Üí saves to `pca_directions.pt`
- **Config 1**: Loads pre-normalized PCA from `pca_directions.pt` ‚Üí uses directly (no re-normalization)
- **Result**: **Exactly the same direction vectors!**

### Pre-Normalization Strategy

The directions are normalized based on **trained model parameters** and saved. When loaded:
- They are used **directly** without re-normalization
- This ensures the **exact same direction vectors** are used at both positions
- The landscape structure will be **identical** (same "hole", same shape)

### Same Parameters
- `seed: 42` - Same initialization
- `range_scale: 1.5` - Same sampling range
- `grid_size_2d: 50` - Same resolution
- `directions: "pca"` - All use PCA directions

## üöÄ Usage

### **IMPORTANT: Run Config 2 First!**

```bash
# Step 1: Run config 2 FIRST to generate normalized PCA directions
losslandscape demo run demos/configs/wide_landscape_comparison/02_trained_with_pca.yaml

# Step 2: Run config 1 to use the same normalized PCA directions at init
losslandscape demo run demos/configs/wide_landscape_comparison/01_init_with_pca.yaml

# Step 3 (optional): Run config 3 for comparison
losslandscape demo run demos/configs/wide_landscape_comparison/03_brief_trained_with_pca.yaml
```

### Or Run All at Once

```bash
# Run all configs (config 2 must run first to generate PCA file)
losslandscape demo run demos/configs/wide_landscape_comparison/*.yaml
```

## üìä What You'll See

### Config 2: Trained Position (Generates PCA)
- **Position**: After 100 epochs of training
- **Directions**: PCA (computed from full training, **normalized and saved**)
- **Landscape**: Shows the landscape at the trained position
- **Output**: Creates `pca_directions.pt` file with normalized directions

### Config 1: Initial Position (Uses Same PCA)
- **Position**: Random initialization
- **Directions**: PCA (**loaded from config 2's file, used directly without re-normalization**)
- **Landscape**: Shows the landscape in the **exact same direction** as config 2, but at init
- **Key**: You'll see the **identical landscape structure** (same "hole", same shape)!

### Comparison: Config 1 vs Config 2

By comparing these two configs, you can observe:
- ‚úÖ **Identical PCA directions** (exact same direction vectors)
- ‚úÖ **Identical landscape structure** (same "hole", same valleys and peaks)
- ‚úÖ **Different positions** (init vs trained)
- ‚úÖ **Different loss values** (high at init, low at trained position)
- ‚úÖ **Same viewing angle** (you're looking at the same plane in parameter space)

## ‚öôÔ∏è Technical Details

### Pre-Normalized Directions

The `pca_directions.pt` file contains:
- `directions`: List of 3 PCA direction vectors (**already filter-wise normalized**)
- `range_scale`: Recommended range scale based on trajectory
- `normalized: True`: Flag indicating directions are pre-normalized
- `raw_directions`: Original unnormalized directions (for reference)

### How It Works

1. **Config 2** trains 100 epochs, records trajectory
2. Computes PCA directions from trajectory
3. **Normalizes directions** using filter-wise normalization (based on trained model)
4. Saves **normalized directions** to `pca_directions.pt`
5. Samples landscape at trained position using these directions

6. **Config 1** loads `pca_directions.pt`
7. Detects `normalized: True` flag
8. **Skips re-normalization** (uses directions directly)
9. Samples landscape at initial position using **exact same direction vectors**

### Why This Works

By using pre-normalized directions without re-normalization:
- The **direction vectors are identical** at both positions
- The **landscape structure is identical** (same viewing plane)
- Only the **loss values differ** (high at init, low at trained)

## üí° Tips

1. **Always run Config 2 first** to generate the normalized PCA directions file
2. **Check the file exists**: `ls demos/configs/wide_landscape_comparison/pca_directions.pt`
3. **Compare side-by-side**: Use the web viewer to compare Config 1 and Config 2
4. **Same seed**: All configs use seed 42, ensuring consistent initialization
5. **Verify**: The landscape shapes should be **identical** (same "hole", same structure)

## üìù Notes

- The PCA directions file is saved relative to the project root
- If you delete the file, Config 1 will fall back to `pca_at_init` mode (may differ)
- The directions are normalized based on **trained model parameters**
- When used at initial position, they maintain the same direction vectors
- This ensures **identical landscape structure** at both positions

## ‚ö†Ô∏è Important

The directions are normalized based on **trained model parameters**. When used at initial position:
- The direction vectors are **identical** (same viewing angle)
- The landscape structure is **identical** (same "hole", same shape)
- The loss values are **different** (expected: high at init, low at trained)

This is the correct behavior for seeing the **same landscape structure** at different positions!

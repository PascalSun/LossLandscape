/* Minimal client-side i18n (EN/ä¸­æ–‡) with a header language toggle. */
'use client';

import React, { createContext, useContext, useEffect, useMemo, useState } from 'react';

export type Locale = 'en' | 'zh';

const DICT = {
  en: {
    appName: 'LearnableKGE',
    tagline: 'Visualize 2D/3D loss landscapes and training trajectories',
    navGenerate: 'Generate',
    navViewer: 'Viewer',
    panelGenerateTitle: 'Generate',
    inputSource: 'Input source',
    fromConfig: 'From Config',
    fromRun: 'From Run',
    configPath: 'Config path',
    runDir: 'Run directory',
    repoRelative: 'repo-relative',
    loadFromRunHint: 'Select a run directory to load landscape data from outputs/run_xxx/',
    noRunsFound: 'No runs found',
    loading: 'Loadingâ€¦',
    optional: 'optional',
    runHint: 'If run is set, config is ignored; config + trajectory are extracted from the run folder.',
    mode: 'Generation Mode',
    mode2D: '2D Grid',
    mode3D: '3D Volume',
    grid: 'Grid',
    direction: 'Direction',
    generate: 'Generate',
    generating: 'Generatingâ€¦',
    perfHint: 'Tip: 3D + grid=50 can be slow; try 30 first.',
    perfPresets: 'Quick Presets',
    presetFast: 'âš¡ Fast',
    presetStandard: 'ğŸ“Š Standard',
    presetHQ: 'ğŸ’ High Quality',
    maxBatches: 'Max Batches',
    viewerTitle: 'Viewer',
    noDataTitle: 'No data yet',
    noDataDesc: 'Select a run directory to load landscape data.',
    loadingOverlay: 'Generating loss landscapeâ€¦',
    historyTitle: 'History',
    historyHint: 'Load previously generated results (stored in DuckDB).',
    refresh: 'Refresh',
    load: 'Load',
    importTitle: 'Import',
    importHint: 'Import .npz files generated by loss landscape generation. Upload a file or scan a folder to automatically import all .npz files.',
    import: 'Import',
    uploadFile: 'Upload File',
    uploadHint: 'Upload a .npz file from your computer',
    selectFile: 'Select .npz file',
    fileSelected: 'File selected',
    scanFolder: 'Scan Folder',
    scanFolderHint: 'Scan a run directory (e.g., outputs/run_xxx) to automatically import all .npz files',
    folderPath: 'Folder path',
    scanAndImport: 'Scan & Import All',
    scanning: 'Scanningâ€¦',
    importing: 'Importingâ€¦',
    filesFound: 'files found',
    filesImported: 'files imported',
    viewMode: 'View Mode',
    view2D: '2D Heatmap',
    viewSurface: '3D Surface',
    viewSurfaceSlice: '3D Surface (Î³ slice)',
    viewSlice: '3D Slice',
    viewVolume: '3D Volume Render',
    gamma: 'Î³',
    opacity: 'Opacity',
    step: 'Step',
    lowerIsBetter: 'Lower is better',
    view2DDesc: 'Shows loss in 2D (Î±, Î²). Good for understanding loss variations in two directions.',
    view3DSurfaceDesc: 'Shows loss as 3D surface (Î±, Î², loss). Good for seeing the overall shape.',
    view3DSurfaceSliceDesc: 'Pick a Î³ slice of the 3D volume and view it as a 3D surface. Use the slider to move through slices.',
    view3DSliceDesc: 'Shows 2D slices of 3D volume at different Î³ values. Reveals how loss changes along the third dimension.',
    view3DVolumeDesc: 'Shows all slices blended together. Reveals 3D structure and high-loss regions.',
  },
  zh: {
    appName: 'LearnableKGE',
    tagline: 'å¯è§†åŒ– 2D/3D loss landscape ä¸è®­ç»ƒè½¨è¿¹',
    navGenerate: 'ç”Ÿæˆ',
    navViewer: 'é¢„è§ˆ',
    panelGenerateTitle: 'ç”Ÿæˆ',
    inputSource: 'è¾“å…¥æ¥æº',
    fromConfig: 'ä» Config',
    fromRun: 'ä» Run',
    configPath: 'Config è·¯å¾„',
    runDir: 'Run ç›®å½•',
    repoRelative: 'ç›¸å¯¹ä»“åº“è·¯å¾„',
    loadFromRunHint: 'é€‰æ‹©ä¸€ä¸ª run ç›®å½•ï¼Œä» outputs/run_xxx/ åŠ è½½ landscape æ•°æ®',
    noRunsFound: 'æœªæ‰¾åˆ° run',
    loading: 'åŠ è½½ä¸­â€¦',
    optional: 'å¯é€‰',
    runHint: 'å¦‚æœå¡«å†™ runï¼Œä¼šå¿½ç•¥ configï¼Œå¹¶ä» run ç›®å½•è‡ªåŠ¨æå– config + trajectoryã€‚',
    mode: 'ç”Ÿæˆæ¨¡å¼',
    mode2D: '2D ç½‘æ ¼',
    mode3D: '3D ä½“ç§¯',
    grid: 'ç½‘æ ¼',
    direction: 'æ–¹å‘',
    generate: 'ç”Ÿæˆ',
    generating: 'ç”Ÿæˆä¸­â€¦',
    perfHint: 'æç¤ºï¼š3D + grid=50 ä¼šæ¯”è¾ƒæ…¢ï¼Œå»ºè®®å…ˆç”¨ 30ã€‚',
    perfPresets: 'å¿«é€Ÿé¢„è®¾',
    presetFast: 'âš¡ å¿«é€Ÿ',
    presetStandard: 'ğŸ“Š æ ‡å‡†',
    presetHQ: 'ğŸ’ é«˜è´¨é‡',
    maxBatches: 'æœ€å¤§æ‰¹æ¬¡',
    viewerTitle: 'é¢„è§ˆ',
    noDataTitle: 'æš‚æ— æ•°æ®',
    noDataDesc: 'é€‰æ‹©ä¸€ä¸ª run ç›®å½•ä»¥åŠ è½½ landscape æ•°æ®ã€‚',
    loadingOverlay: 'æ­£åœ¨ç”Ÿæˆ loss landscapeâ€¦',
    historyTitle: 'å†å²è®°å½•',
    historyHint: 'åŠ è½½å·²ç”Ÿæˆç»“æœï¼ˆå­˜å‚¨åœ¨ DuckDBï¼‰ã€‚',
    refresh: 'åˆ·æ–°',
    load: 'è½½å…¥',
    importTitle: 'å¯¼å…¥',
    importHint: 'å¯¼å…¥ loss landscape ç”Ÿæˆäº§ç”Ÿçš„ .npz æ–‡ä»¶ã€‚å¯ä»¥ä¸Šä¼ å•ä¸ªæ–‡ä»¶æˆ–æ‰«ææ–‡ä»¶å¤¹è‡ªåŠ¨å¯¼å…¥æ‰€æœ‰ .npz æ–‡ä»¶ã€‚',
    import: 'å¯¼å…¥',
    uploadFile: 'ä¸Šä¼ æ–‡ä»¶',
    uploadHint: 'ä»æ‚¨çš„ç”µè„‘ä¸Šä¼  .npz æ–‡ä»¶',
    selectFile: 'é€‰æ‹© .npz æ–‡ä»¶',
    fileSelected: 'å·²é€‰æ‹©æ–‡ä»¶',
    scanFolder: 'æ‰«ææ–‡ä»¶å¤¹',
    scanFolderHint: 'æ‰«æ run ç›®å½•ï¼ˆå¦‚ outputs/run_xxxï¼‰è‡ªåŠ¨å¯¼å…¥æ‰€æœ‰ .npz æ–‡ä»¶',
    folderPath: 'æ–‡ä»¶å¤¹è·¯å¾„',
    scanAndImport: 'æ‰«æå¹¶å¯¼å…¥å…¨éƒ¨',
    scanning: 'æ‰«æä¸­â€¦',
    importing: 'å¯¼å…¥ä¸­â€¦',
    filesFound: 'ä¸ªæ–‡ä»¶',
    filesImported: 'ä¸ªæ–‡ä»¶å·²å¯¼å…¥',
    viewMode: 'è§†å›¾æ¨¡å¼',
    view2D: '2D çƒ­å›¾',
    viewSurface: '3D æ›²é¢',
    viewSurfaceSlice: '3D æ›²é¢(Î³åˆ‡ç‰‡)',
    viewSlice: '3D åˆ‡ç‰‡',
    viewVolume: '3D ä½“æ¸²æŸ“',
    gamma: 'Î³',
    opacity: 'é€æ˜åº¦',
    step: 'æ­¥é•¿',
    lowerIsBetter: 'è¶Šä½è¶Šå¥½',
    view2DDesc: 'æ˜¾ç¤º2D loss landscape (Î±, Î²)ã€‚é€‚åˆç†è§£ä¸¤ä¸ªæ–¹å‘ä¸Šçš„losså˜åŒ–ã€‚',
    view3DSurfaceDesc: 'æ˜¾ç¤º3D loss æ›²é¢ (Î±, Î², loss)ï¼Œä¾¿äºæ•´ä½“è§‚å¯Ÿå½¢çŠ¶ã€‚',
    view3DSurfaceSliceDesc: 'å¯¹3Dä½“ç§¯æŒ‰Î³å–åˆ‡ç‰‡ï¼Œç”¨3Dæ›²é¢å±•ç¤ºã€‚æ‹–åŠ¨æ»‘æ¡åœ¨ä¸åŒåˆ‡ç‰‡é—´åˆ‡æ¢ã€‚',
    view3DSliceDesc: 'æ˜¾ç¤º3Dä½“ç§¯åœ¨ä¸åŒÎ³å€¼ä¸‹çš„2Dåˆ‡ç‰‡ã€‚æ­ç¤ºlossåœ¨ç¬¬ä¸‰ä¸ªç»´åº¦ä¸Šçš„å˜åŒ–ã€‚',
    view3DVolumeDesc: 'æ˜¾ç¤ºæ‰€æœ‰åˆ‡ç‰‡æ··åˆå åŠ ã€‚æ­ç¤º3Dç»“æ„å’Œé«˜lossåŒºåŸŸã€‚',
  },
} as const satisfies Record<Locale, Record<string, string>>;

type DictKey = keyof typeof DICT.en;
type Dict = Record<DictKey, string>;

const I18nCtx = createContext<{
  locale: Locale;
  setLocale: (l: Locale) => void;
  t: Dict;
} | null>(null);

export function I18nProvider({ children }: { children: React.ReactNode }) {
  const [locale, setLocale] = useState<Locale>('zh');

  useEffect(() => {
    const saved = typeof window !== 'undefined' ? window.localStorage.getItem('locale') : null;
    if (saved === 'en' || saved === 'zh') setLocale(saved);
  }, []);

  useEffect(() => {
    if (typeof window !== 'undefined') window.localStorage.setItem('locale', locale);
  }, [locale]);

  const value = useMemo(() => ({ locale, setLocale, t: DICT[locale] }), [locale]);
  return <I18nCtx.Provider value={value}>{children}</I18nCtx.Provider>;
}

export function useI18n() {
  const ctx = useContext(I18nCtx);
  if (!ctx) throw new Error('useI18n must be used within I18nProvider');
  return ctx;
}


